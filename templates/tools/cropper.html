{% extends 'base.html' %}

{% block title %}Image Cropper - ToolBox Pro{% endblock %}

{% block extra_css %}
<style>
    /* Modern Figma/Canva-inspired layout */
    body {
        overflow: hidden;
    }

    .cropper-wrapper {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        background: #1a1d2e;
        z-index: 1;
    }

    /* Top Toolbar */
    .cropper-toolbar {
        height: 60px;
        background: rgba(30, 35, 50, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        gap: 1rem;
        flex-shrink: 0;
        z-index: 50;
    }

    .toolbar-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .toolbar-divider {
        width: 1px;
        height: 30px;
        background: rgba(255, 255, 255, 0.1);
        margin: 0 0.5rem;
    }

    .toolbar-btn {
        padding: 0.5rem 1rem;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 0.5rem;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .toolbar-btn:hover:not(:disabled) {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.5);
    }

    .toolbar-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .toolbar-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
    }

    /* Main Content Area */
    .cropper-main {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* Left Sidebar */
    .cropper-sidebar {
        width: 280px;
        background: rgba(30, 35, 50, 0.95);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        flex-shrink: 0;
    }

    .sidebar-section {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar-section h3 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 1rem;
    }

    /* Canvas Area */
    .cropper-canvas-area {
        flex: 1;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        background: #1a1d2e;
        position: relative;
        overflow: auto;
        padding: 20px;
    }

    .canvas-wrapper {
        position: relative;
        display: inline-block;
    }

    #cropCanvas {
        display: block;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    /* Right Panel */
    .cropper-right-panel {
        width: 320px;
        background: rgba(30, 35, 50, 0.95);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }

    .panel-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-header h3 {
        font-size: 1rem;
        margin: 0;
    }

    .preview-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .preview-grid {
        display: grid;
        gap: 1rem;
    }

    .preview-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.2s;
    }

    .preview-item:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }

    .preview-item img {
        width: 100%;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
    }

    .preview-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .info-badge {
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.85rem;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.8);
    }

    /* File input styling */
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }

    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }

    /* Responsive */
    @media (max-width: 1024px) {

        .cropper-sidebar,
        .cropper-right-panel {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="cropper-wrapper fade-in">
    <!-- Top Toolbar -->
    <div class="cropper-toolbar">
        <div class="toolbar-group">
            <label class="toolbar-btn primary file-input-wrapper">
                üìÅ Upload Image
                <input type="file" id="imageUpload" accept="image/*">
            </label>

            {% if user.is_authenticated and user.is_pro %}
            <label class="toolbar-btn file-input-wrapper"
                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;">
                ‚≠ê Batch Upload
                <input type="file" id="batchUpload" accept="image/*" multiple>
            </label>
            {% endif %}
        </div>

        <div class="toolbar-divider"></div>

        <div class="toolbar-group">
            <button id="detectBtn" class="toolbar-btn" disabled>üîç Auto-Detect</button>
            <button id="clearBtn" class="toolbar-btn">üóëÔ∏è Clear All</button>
        </div>

        <div style="flex: 1"></div>

        <div class="toolbar-group">
            <button id="downloadBtn" class="toolbar-btn primary" disabled>
                ‚¨áÔ∏è Download ZIP (<span id="previewCount">0</span>)
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="cropper-main">
        <!-- Left Sidebar -->
        <div class="cropper-sidebar">
            <div class="sidebar-section">
                <h3>Instructions</h3>
                <div class="info-badge">
                    <strong>Quick Start:</strong><br>
                    ‚Ä¢ Upload single or multiple images<br>
                    ‚Ä¢ Click empty space to draw crop areas<br>
                    ‚Ä¢ Drag images to reposition<br>
                    ‚Ä¢ Resize images by dragging corners<br>
                    ‚Ä¢ Auto-detect for automatic panel detection<br>
                    ‚Ä¢ Download individual or batch ZIP
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Tips</h3>
                <div class="info-badge">
                    üí° <strong>Pro Tip:</strong> You can move and resize images freely like in Canva. Click on empty
                    canvas to draw crop rectangles.
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="cropper-canvas-area">
            <div class="canvas-wrapper">
                <canvas id="cropCanvas"></canvas>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="cropper-right-panel">
            <div class="panel-header">
                <h3>üì∏ Cropped Panels</h3>
            </div>
            <div class="preview-container">
                <div id="previewGrid" class="preview-grid"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="/static/js/cropper.js"></script>
{% endblock %}